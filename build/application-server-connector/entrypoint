#!/bin/bash
set -e

ZOOKEEPER="${ZOOKEEPER:="zookeeper:2181"}"
CONNECT="${CONNECT:="http://connect:8083"}"

createTopic() {
  local topic="${1}"
  local partitions="${2}"
  kafka-topics --create --zookeeper "${ZOOKEEPER}" --topic "${topic}" --replication-factor 1 --partitions "${partitions}" --if-not-exists
  sleep 2
  kafka-topics --alter --zookeeper "${ZOOKEEPER}" --topic "${topic}" --partitions "${partitions}" --if-exists
  sleep 2
}

# Create topics
createTopic accounts 20
createTopic transactions 40
createTopic blocks 5
createTopic messages 60
createTopic requests 30
createTopic blocks_signatures 5

# Create connectors
CONNECTORS=$(ls /work/connectors)
for connector in ${CONNECTORS}
do
    java -jar /usr/bin/connect-cli create -e "${CONNECT}" "$(awk -F "." '{print $1}' <<< "${connector}")" < "/work/connectors/${connector}"
    sleep 10s
done

# Endless
exec tail -f /dev/null

